{% extends "base.html" %}

{% block title %}RecepciÃ³n - Dashboard{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-5 gap-8">

    <!-- Columna Izquierda: Registrar MediciÃ³n -->
    <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-ruler-combined text-gray-500 mr-3"></i>Registrar Nueva MediciÃ³n</h2>
        <form action="{{ url_for('add_measurement') }}" method="POST" class="space-y-6">
            <!-- Buscador de Pacientes -->
            <div class="relative">
                <label for="search_patient" class="block text-sm font-medium text-gray-700 mb-1">Buscar Paciente</label>
                <input type="text" id="search_patient" placeholder="Escribe el nombre del paciente..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                <div id="search_results" class="absolute w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-10"></div>
            </div>
            
            <input type="hidden" id="id_paciente" name="id_paciente" required>
            
            <!-- Info del paciente seleccionado -->
            <div id="patient_info_card" class="bg-green-50 p-4 rounded-md border border-green-200" style="display: none;">
                <h3 class="font-semibold text-green-800">Paciente: <span id="selected_patient_name"></span></h3>
                <p class="text-sm text-gray-600"><strong>NutriÃ³logo:</strong> <span id="current_nutriologo"></span></p>
                <p class="text-sm text-gray-600"><strong>Entrenador:</strong> <span id="current_entrenador"></span></p>
            </div>

            <!-- Campos de MediciÃ³n -->
            <div>
                 <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Datos de la MediciÃ³n</h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><label class="block text-sm font-medium">âš–ï¸ Peso (kg)</label><input type="number" step="0.01" name="peso" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ“ Altura (m)</label><input type="number" step="0.01" name="altura" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ” % Grasa Corporal</label><input type="number" step="0.1" name="grasa_corporal_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ’ª % Masa Muscular</label><input type="number" step="0.1" name="masa_muscular_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ”¥ BMR (kcal)</label><input type="number" name="bmr_kcal" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">âš¡ AMR (kcal)</label><input type="number" name="amr_kcal" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ’§ % Agua Corporal</label><input type="number" step="0.1" name="agua_corporal_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ¦´ Masa Ã“sea (kg)</label><input type="number" step="0.01" name="masa_osea_kg" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium">ğŸ¯ Grasa Visceral</label><input type="number" step="0.1" name="grasa_visceral" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                 </div>
            </div>
            
            <!-- AnÃ¡lisis Segmental -->
            <div>
                <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">ğŸ”¬ AnÃ¡lisis Segmental (%)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><label class="block text-sm font-medium">ğŸ‘• % Grasa Tronco</label><input type="number" step="0.1" name="grasa_tronco_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ‘• % MÃºsculo Tronco</label><input type="number" step="0.1" name="musculo_tronco_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ’ª % Grasa Brazo Der.</label><input type="number" step="0.1" name="grasa_brazo_der_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ’ª % MÃºsculo Brazo Der.</label><input type="number" step="0.1" name="musculo_brazo_der_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ’ª % Grasa Brazo Izq.</label><input type="number" step="0.1" name="grasa_brazo_izq_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ’ª % MÃºsculo Brazo Izq.</label><input type="number" step="0.1" name="musculo_brazo_izq_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ¦µ % Grasa Pierna Der.</label><input type="number" step="0.1" name="grasa_pierna_der_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ¦µ % MÃºsculo Pierna Der.</label><input type="number" step="0.1" name="musculo_pierna_der_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ¦µ % Grasa Pierna Izq.</label><input type="number" step="0.1" name="grasa_pierna_izq_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ğŸ¦µ % MÃºsculo Pierna Izq.</label><input type="number" step="0.1" name="musculo_pierna_izq_pct" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                </div>
            </div>

            <div>
                <label for="observaciones" class="block text-sm font-medium text-gray-700">ğŸ“‹ Observaciones</label>
                <textarea id="observaciones" name="observaciones" rows="3" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></textarea>
            </div>
            
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition-colors">Guardar MediciÃ³n</button>
        </form>
    </div>
    
    <!-- Columna Derecha: Registrar Paciente y Reasignar -->
    <div class="lg:col-span-2 space-y-8">
        <!-- Registrar Nuevo Paciente -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-user-plus text-gray-500 mr-3"></i>Registrar Nuevo Paciente</h2>
            <form action="{{ url_for('add_patient') }}" method="POST" class="space-y-4">
                <div><label class="block text-sm font-medium">Nombre Completo</label><input type="text" name="nombre_completo" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div>
                <div><label class="block text-sm font-medium">Fecha de Nacimiento</label><input type="date" name="fecha_nacimiento" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                <div><label class="block text-sm font-medium">Estatura (cm)</label><input type="number" step="0.1" name="estatura_cm" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                <div><label class="block text-sm font-medium">TelÃ©fono</label><input type="tel" name="telefono" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                <div><label class="block text-sm font-medium">Email</label><input type="email" name="email" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                <div><label class="block text-sm font-medium">Asignar NutriÃ³logo</label><select name="id_nutriologo_asignado" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"><option value="">-- Sin asignar --</option>{% for n in nutriologos %}<option value="{{ n.id }}">{{ n.nombre }}</option>{% endfor %}</select></div>
                <div><label class="block text-sm font-medium">Asignar Entrenador</label><select name="id_entrenador_asignado" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"><option value="">-- Sin asignar --</option>{% for e in entrenadores %}<option value="{{ e.id }}">{{ e.nombre }}</option>{% endfor %}</select></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors">Registrar Paciente</button>
            </form>
        </div>

        <!-- Reasignar Profesionales (inicialmente oculto) -->
        <div id="reassign_card" class="bg-white p-6 rounded-lg shadow-md" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-random text-gray-500 mr-3"></i>Reasignar Profesionales</h2>
            <form id="reassign_form" method="POST" class="space-y-4">
                <div>
                    <label for="reassign_nutriologo" class="block text-sm font-medium">NutriÃ³logo</label>
                    <select id="reassign_nutriologo" name="id_nutriologo_asignado" class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                        <option value="null">-- Desasignar --</option>
                        {% for n in nutriologos %}<option value="{{ n.id }}">{{ n.nombre }}</option>{% endfor %}
                    </select>
                </div>
                <div>
                    <label for="reassign_entrenador" class="block text-sm font-medium">Entrenador</label>
                    <select id="reassign_entrenador" name="id_entrenador_asignado" class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                        <option value="null">-- Desasignar --</option>
                        {% for e in entrenadores %}<option value="{{ e.id }}">{{ e.nombre }}</option>{% endfor %}
                    </select>
                </div>
                <button type="submit" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-md transition-colors">Actualizar Asignaciones</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search_patient');
    const searchResults = document.getElementById('search_results');
    
    searchInput.addEventListener('keyup', function() {
        let query = this.value;
        if (query.length > 2) {
            fetch(`{{ url_for('search_patients') }}?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    searchResults.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(patient => {
                            const patientData = JSON.stringify(patient).replace(/'/g, "&apos;");
                            searchResults.innerHTML += `<a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-patient='${patientData}'>${patient.nombre_completo}</a>`;
                        });
                    } else {
                        searchResults.innerHTML = `<div class="px-4 py-2 text-sm text-gray-500">No se encontraron pacientes.</div>`;
                    }
                });
        } else {
            searchResults.innerHTML = '';
        }
    });

    document.addEventListener('click', function(e) {
        if (e.target.closest('#search_results a')) {
            e.preventDefault();
            let patient = JSON.parse(e.target.closest('a').dataset.patient);

            document.getElementById('id_paciente').value = patient.id;
            if (patient.estatura_cm) {
                document.querySelector('input[name="altura"]').value = (patient.estatura_cm / 100).toFixed(2);
            }

            document.getElementById('selected_patient_name').textContent = patient.nombre_completo;
            document.getElementById('current_nutriologo').textContent = patient.nutriologo_nombre || 'No asignado';
            document.getElementById('current_entrenador').textContent = patient.entrenador_nombre || 'No asignado';
            document.getElementById('patient_info_card').style.display = 'block';
            document.getElementById('reassign_card').style.display = 'block';

            document.getElementById('reassign_form').action = `/paciente/${patient.id}/update_assignments`;

            searchResults.innerHTML = '';
            searchInput.value = '';
        } else if (!e.target.closest('#search_patient')) {
            searchResults.innerHTML = '';
        }
    });
});
</script>
{% endblock %}