{% extends "base.html" %}

{% block title %}Expediente de {{ paciente.nombre_completo }}{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- CABECERA DEL EXPEDIENTE -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex flex-col md:flex-row justify-between md:items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-user-injured text-gray-400 mr-4"></i>
                    Expediente de: {{ paciente.nombre_completo }}
                </h1>
                <p class="text-gray-600 mt-2">
                    <strong>Fecha de Nacimiento:</strong> {{ paciente.fecha_nacimiento.strftime('%d-%m-%Y') if paciente.fecha_nacimiento else 'No registrado' }} |
                    <strong>Estatura:</strong> {{ "%.1f"|format(paciente.estatura_cm) if paciente.estatura_cm is not none else 'N/A' }} cm |
                    <strong>Nutriólogo:</strong> {{ paciente.nutriologo_nombre or 'No asignado' }} |
                    <strong>Entrenador:</strong> {{ paciente.entrenador_nombre or 'No asignado' }}
                </p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center space-x-2">
                <a href="{{ url_for('generar_pdf', paciente_id=paciente.id) }}" target="_blank" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
                    <i class="fas fa-file-pdf mr-2"></i>Descargar
                </a>
                <a href="{{ url_for('editar_historial_clinico', paciente_id=paciente.id) }}" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">
                    <i class="fas fa-edit mr-2"></i>Editar Historial
                </a>
            </div>
        </div>
    </div>

    <!-- GRÁFICAS Y ARCHIVOS -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <!-- Columna de Gráficas -->
        <div class="xl:col-span-2 space-y-8">
            <!-- Evolución Corporal -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-chart-line mr-2"></i>Evolución Corporal</h2>
                <div class="relative h-96">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
            <!-- Análisis Segmental -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-crosshairs mr-2"></i>Análisis Segmental (Última Medición)</h2>
                {% if radar_data_json and radar_data_json != '{}' %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="relative h-80">
                        <canvas id="muscleRadarChart"></canvas>
                    </div>
                    <div class="relative h-80">
                        <canvas id="fatRadarChart"></canvas>
                    </div>
                </div>
                {% else %}
                <p class="text-center text-gray-500 py-8">No hay suficientes datos para el análisis segmental.</p>
                {% endif %}
            </div>
        </div>
        <!-- Columna de Archivos -->
        <div class="xl:col-span-1 space-y-6">
            <!-- Dietas -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-file-alt mr-2"></i>Dietas Asignadas</h3>
                <ul class="space-y-2">
                    {% for dieta in dietas %}
                    <li class="flex items-center justify-between bg-gray-50 p-2 rounded-md">
                        <a href="{{ url_for('download_file', filename=dieta.nombre_archivo_guardado) }}" class="text-green-700 hover:underline text-sm truncate" title="{{ dieta.nombre_archivo_original }}">
                            <i class="fas fa-download mr-2"></i>{{ dieta.nombre_archivo_original }}
                        </a>
                        <form action="{{ url_for('delete_pdf', file_type='dieta', file_id=dieta.id) }}" method="POST" onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta dieta?');">
                           <button type="submit" class="text-red-500 hover:text-red-700 ml-2"><i class="fas fa-trash-alt"></i></button>
                        </form>
                    </li>
                    {% else %}
                    <li class="text-center text-gray-500 text-sm">No hay dietas.</li>
                    {% endfor %}
                </ul>
                <form action="{{ url_for('upload_pdf', paciente_id=paciente.id) }}" method="POST" enctype="multipart/form-data" class="mt-4">
                    <input type="hidden" name="file_type" value="dieta">
                    <input type="file" name="archivo_pdf" class="text-sm w-full border rounded-md p-1" required>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors mt-2 text-sm">Subir Dieta</button>
                </form>
            </div>
            <!-- Rutinas -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-dumbbell mr-2"></i>Rutinas Asignadas</h3>
                <ul class="space-y-2">
                    {% for rutina in rutinas %}
                     <li class="flex items-center justify-between bg-gray-50 p-2 rounded-md">
                        <a href="{{ url_for('download_file', filename=rutina.nombre_archivo_guardado) }}" class="text-green-700 hover:underline text-sm truncate" title="{{ rutina.nombre_archivo_original }}">
                            <i class="fas fa-download mr-2"></i>{{ rutina.nombre_archivo_original }}
                        </a>
                        <form action="{{ url_for('delete_pdf', file_type='rutina', file_id=rutina.id) }}" method="POST" onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta rutina?');">
                           <button type="submit" class="text-red-500 hover:text-red-700 ml-2"><i class="fas fa-trash-alt"></i></button>
                        </form>
                    </li>
                    {% else %}
                    <li class="text-center text-gray-500 text-sm">No hay rutinas.</li>
                    {% endfor %}
                </ul>
                 <form action="{{ url_for('upload_pdf', paciente_id=paciente.id) }}" method="POST" enctype="multipart/form-data" class="mt-4">
                    <input type="hidden" name="file_type" value="rutina">
                    <input type="file" name="archivo_pdf" class="text-sm w-full border rounded-md p-1" required>
                    <button type="submit" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors mt-2 text-sm">Subir Rutina</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ANÁLISIS SEGMENTAL DETALLADO (DOS TABLAS) -->
    {% if mediciones_desc %}
        {% set ultima_medicion = mediciones_desc[0] %}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Tabla de Porcentajes -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-percentage mr-2"></i>Análisis Segmental (%)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white text-sm">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="text-left py-2 px-3">Segmento</th>
                                <th class="text-center py-2 px-3">Grasa (%)</th>
                                <th class="text-center py-2 px-3">Músculo (%)</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700">
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Tronco</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.grasa_tronco_pct) if ultima_medicion.grasa_tronco_pct is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.musculo_tronco_pct) if ultima_medicion.musculo_tronco_pct is not none else 'N/A' }}</td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Brazo Derecho</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.grasa_brazo_der_pct) if ultima_medicion.grasa_brazo_der_pct is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.musculo_brazo_der_pct) if ultima_medicion.musculo_brazo_der_pct is not none else 'N/A' }}</td>
                            </tr>
                             <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Brazo Izquierdo</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.grasa_brazo_izq_pct) if ultima_medicion.grasa_brazo_izq_pct is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.musculo_brazo_izq_pct) if ultima_medicion.musculo_brazo_izq_pct is not none else 'N/A' }}</td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Pierna Derecha</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.grasa_pierna_der_pct) if ultima_medicion.grasa_pierna_der_pct is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.musculo_pierna_der_pct) if ultima_medicion.musculo_pierna_der_pct is not none else 'N/A' }}</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Pierna Izquierda</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.grasa_pierna_izq_pct) if ultima_medicion.grasa_pierna_izq_pct is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.1f"|format(ultima_medicion.musculo_pierna_izq_pct) if ultima_medicion.musculo_pierna_izq_pct is not none else 'N/A' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Tabla de Kilogramos -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-weight mr-2"></i>Análisis Segmental (kg)</h2>
                 <div class="overflow-x-auto">
                    <table class="min-w-full bg-white text-sm">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="text-left py-2 px-3">Segmento</th>
                                <th class="text-center py-2 px-3">Grasa (kg)</th>
                                <th class="text-center py-2 px-3">Músculo (kg)</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700">
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Tronco</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.grasa_tronco_kg) if ultima_medicion.grasa_tronco_kg is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.musculo_tronco_kg) if ultima_medicion.musculo_tronco_kg is not none else 'N/A' }}</td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Brazo Derecho</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.grasa_brazo_der_kg) if ultima_medicion.grasa_brazo_der_kg is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.musculo_brazo_der_kg) if ultima_medicion.musculo_brazo_der_kg is not none else 'N/A' }}</td>
                            </tr>
                             <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Brazo Izquierdo</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.grasa_brazo_izq_kg) if ultima_medicion.grasa_brazo_izq_kg is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.musculo_brazo_izq_kg) if ultima_medicion.musculo_brazo_izq_kg is not none else 'N/A' }}</td>
                            </tr>
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Pierna Derecha</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.grasa_pierna_der_kg) if ultima_medicion.grasa_pierna_der_kg is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.musculo_pierna_der_kg) if ultima_medicion.musculo_pierna_der_kg is not none else 'N/A' }}</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="py-2 px-3 font-medium">Pierna Izquierda</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.grasa_pierna_izq_kg) if ultima_medicion.grasa_pierna_izq_kg is not none else 'N/A' }}</td>
                                <td class="text-center py-2 px-3">{{ "%.2f"|format(ultima_medicion.musculo_pierna_izq_kg) if ultima_medicion.musculo_pierna_izq_kg is not none else 'N/A' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- HISTORIAL DE MEDICIONES -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-history mr-2"></i>Historial de Mediciones</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white text-sm">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th class="text-left py-2 px-3">Fecha</th>
                        <th class="text-center py-2 px-3">Peso (kg)</th>
                        <th class="text-center py-2 px-3">IMC</th>
                        <th class="text-center py-2 px-3">% Grasa</th>
                        <th class="text-center py-2 px-3">Músculo (kg)</th>
                        <th class="text-center py-2 px-3">Grasa Visc.</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700">
                    {% for med in mediciones_desc %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-2 px-3">{{ med.fecha_medicion.strftime('%d-%m-%Y') }}</td>
                        <td class="text-center py-2 px-3">{{ "%.2f"|format(med.peso) if med.peso is not none else 'N/A' }}</td>
                        <td class="text-center py-2 px-3">{{ "%.2f"|format(med.imc) if med.imc is not none else 'N/A' }}</td>
                        <td class="text-center py-2 px-3">{{ "%.1f"|format(med.grasa_corporal_pct) if med.grasa_corporal_pct is not none else 'N/A' }}%</td>
                        <td class="text-center py-2 px-3">{{ "%.2f"|format(med.masa_muscular_kg) if med.masa_muscular_kg is not none else 'N/A' }}</td>
                        <td class="text-center py-2 px-3">{{ "%.1f"|format(med.grasa_visceral) if med.grasa_visceral is not none else 'N/A' }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-4 text-gray-500">No hay mediciones registradas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartData = JSON.parse('{{ chart_data_json|safe }}');
    const radarData = JSON.parse('{{ radar_data_json|safe }}');

    // 1. Gráfica de Evolución Corporal
    if (chartData && chartData.labels && chartData.labels.length > 0) {
        const ctxEvolution = document.getElementById('evolutionChart').getContext('2d');
        new Chart(ctxEvolution, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Peso (kg)',
                        data: chartData.peso,
                        borderColor: 'rgba(239, 68, 68, 1)',
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        yAxisID: 'y',
                        fill: true,
                    },
                    {
                        label: '% Grasa Corporal',
                        data: chartData.grasa,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        yAxisID: 'y1',
                        fill: true,
                    },
                    {
                        label: 'Masa Muscular (kg)',
                        data: chartData.musculo,
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        yAxisID: 'y1',
                        fill: true,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { text: 'Peso (kg)', display: true }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { text: '% Grasa / Músculo (kg)', display: true },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }

    // 2. Gráficas de Radar para Análisis Segmental
    if (radarData && radarData.labels) {
        const radarOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    angleLines: { display: false },
                    suggestedMin: 0,
                    pointLabels: { font: { size: 12 } }
                }
            },
            plugins: { legend: { position: 'top' } }
        };

        // Gráfica de Músculo
        const ctxMuscleRadar = document.getElementById('muscleRadarChart').getContext('2d');
        new Chart(ctxMuscleRadar, {
            type: 'radar',
            data: {
                labels: radarData.labels,
                datasets: [{
                    label: 'Músculo (kg)',
                    data: radarData.musculo_kg,
                    borderColor: 'rgba(16, 185, 129, 1)',
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: radarOptions
        });

        // Gráfica de Grasa
        const ctxFatRadar = document.getElementById('fatRadarChart').getContext('2d');
        new Chart(ctxFatRadar, {
            type: 'radar',
            data: {
                labels: radarData.labels,
                datasets: [{
                    label: 'Grasa (kg)',
                    data: radarData.grasa_kg,
                    borderColor: 'rgba(239, 68, 68, 1)',
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: radarOptions
        });
    }
});
</script>
{% endblock %}
